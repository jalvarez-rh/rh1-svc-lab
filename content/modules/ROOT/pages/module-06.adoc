= Assurance

[[cluster-conformance]]

Assurance is critical for sovereignty, ensuring that applications operate in a compliant manner and that clusters maintain compliance across diverse regions and geographies. It is essential to have confidence that compliance reports are accurate, testable, and auditable, thereby supporting and advancing key business objectives. Additionally, enabling teams to collaborate effectively through the use of appropriate tools and technologies helps drive organizational success.

Achieving this level of assurance requires a practical and structured approach.

So let's get practical in our example of an EMEA environment and a US environment. Let's look at practical ways that we can Observe audit Police and manage our clusters and application applications. We will start by looking at the security, compliance and environment insights that we can get from Red Hat Advanced Cluster Security for Kubernetes (RHACS).

== Security and Environment Insights

[[rhacs-insights]]

=== *RHACS Basics*
RHACS provides developers and administrators with tools to meet the security needs of cloud-native development on Kubernetes. Its features address primary security concerns across various environments, including datacenters, private clouds, and public clouds running Kubernetes clusters. With RHACS, you can achieve comprehensive security, covering key areas such as:

*Vulnerability Management*  
Protect nodes, platforms, and applications from vulnerabilities using prioritization and impact-based filters.

*Network Security*  
Gain real-time visibility, enforce network policies, detect anomalies, and manage app-centric network access controls.

*Security Policy Guardrails*  
Ensure consistent, compliant, and secure configurations with RHACS' built-in policy guardrails.

*Compliance*  
Make sure clusters meet regulatory and contractual requirements, such as DISA-STIG and PCI-DSS, with simple audit capabilities.

*Risk Profiling*  
Identify and prioritize security risks using key impact and severity metrics for OpenShift and Kubernetes clusters.

*Threat Detection and Response*
Implement process and network controls to detect malicious runtime incidents and respond using Kubernetes-native enforcement.

=== RHACS console access

Your RHACS Console is available in the showroom environment. In case you want to open it in another window it is here:  {acs_route}[window=blank]

Administrator login is available with:

[cols="1,1"]
|===
| *RHACS Console Username:* | {acs_portal_username} 
| *RHACS Console Password:* | {acs_portal_password} 
|===

== RHACS Compliance Operator Installation and Compliance Checks

[[conformance-tests]]

Before making changes to your cluster, it’s essential to understand your current compliance posture. Red Hat Advanced Cluster Security (RHACS) seamlessly integrates with the OpenShift Compliance Operator to provide out-of-the-box compliance checks—including industry standards such as E8 and DISA STIG. You can also define custom profiles that combine multiple standards into one, streamlining your audit processes and allowing you to easily tailor compliance requirements to your organization or region. This flexibility enables you to create global profiles and maintain consistent, auditable compliance across all OpenShift environments.

=== Checking your compliance posture

The first step to any changes in a cluster is to analyze what you need to change RHACS integrates with the compliance operator to bring you a variety of compliance checks from the E8 to DISA STIG and more. RHACS can also set up custom compliance checks so you can create profiles that have both DISA STIG and E8 standards together for easier auditing and to create a profile that can become global if necessary.

[start=1]
. Click on the *Compliance* -> *OpenShift Schedules*tab.

image::assurance-01.png[link=self, window=blank, width=100%]

[start=2]
. Next, click on the *Create scan schdule*.

image::assurance-02.png[link=self, window=blank, width=100%]

[start=3]
. Next, fill in the form with the following information:

* Name: `acs-catch-all`
* Description: `Daily compliance scan for all profiles covering CIS, E8, Moderate, NERC-CIP, PCI-DSS, and STIG standards for both platform and node-level checks`
* Frequency: *Daily*
* Time: 12:00

. Click Next
. Select the two clusters: *emea-production* and *us-production*
. Click Next
. Add the following profiles (in order):
    * ocp4-cis (99 rules, Platform, Version 1.5.0)
    * ocp4-cis-node (100 rules, Node, Version 1.5.0)
    * ocp4-e8 (14 rules, Platform)
    * ocp4-moderate (136 rules, Platform, Revision 4)
    * ocp4-moderate-node (120 rules, Node, Revision 4)
    * ocp4-nerc-cip (133 rules, Platform)
    * ocp4-nerc-cip-node (120 rules, Node)
    * ocp4-pci-dss (120 rules, Platform, Version 3.2.1)
    * ocp4-pci-dss-node (114 rules, Node, Version 3.2.1)
    * ocp4-stig (50 rules, Platform, Version V2R1)


NOTE: There are many profiles to select but here we are selecting the most common profiles that are used in most organizations. If you want to only add the ones necessary for the lab. Select ......

[start=8]
. Click Next

NOTE: We will not add a delivery destination so we will skip this step. However you can send notifications via email, get details via API or download reports via the console.

[start=9]
. Click Next
. Review your masterpiece and click *Save*

image::assurance-05.png[link=self, window=blank, width=100%]

You should see the new schedule in the list and it will be performing it's first scan. If you click the 3 dots on the right side of the schedule you can trigger a manual scan, download the report or delete the schedule.

image::assurance-06.png[link=self, window=blank, width=100%]

[start=11]

.Head over to the OpenShift coverage section where you can view all of the details from the scan.

image::assurance-07.png[link=self, window=blank, width=100%]

 The RHACS compliance coverage dashboard provides a comprehensive overview of your scan schedules and results. In the Coverage tab, you can review all scan schedules or filter to view specific schedules such as the "acs-catch-all". Each scan displays coverage across a variety of compliance standards—including CIS, OCP, E8, NERC-CIP, NIST 853, PCI-DSS, and DISA-STIG. You can filter results by specific checks for greater detail. On the right side of the dashboard, you’ll see the cluster’s overall compliance status, along with a breakdown of which checks are passing or failing.

=== Analyze Compliance Results

Managing multi-region and multi-geo environments presents specific challenges. Typically, changes are initiated by the operations team, who are responsible for provisioning and managing the infrastructure. They also oversee any modifications needed to enhance security or ensure compliance with applicable standards. Establishing clear processes and leveraging automation can help maintain consistency and compliance across all environments. In OpenShift, cluster changes are done by the administrator or the operations team through the OpenShift console with Red Hat Advanced Cluster Management for Kubernetes (RHACM) providing the governance and policy capabilities.

=== Make a simple cluster change to pass the compliance check

Let's focus on the ocp4-e8 compliance checks. To pass the `ocp4-e8-ocp-allowed-registries` standard, you need to set an allowlist of container registries that OpenShift can pull images from. 

First let's take a look at the standard;

[start=1]
. Click on the *Compliance* -> *OpenShift Coverage* -> *E8* tab.

image::compliance-01.png[link=self, window=blank, width=100%]

[start=2]
Let's first check the failing standards by sorting by compliance status.

image::compliance-02.png[link=self, window=blank, width=100%]
image::compliance-03.png[link=self, window=blank, width=100%]

[start=3]
. And then clicking on the failing standard 'ocp4-e8-ocp-allowed-registries'.

Here you will see both the clusters impacted by this failing standard and guidance on how to resolve the issue.

[start=4]
. Click on the *Details* tab next to *Results* and review the findings for the failing check. 

To address this, limit the set of container registries that OpenShift is allowed to pull images from by configuring the cluster with a new allowlist. We will do this by applying a YAML configuration as an OpenShift administrator, and then re-scan the cluster to verify compliance.

[start=5]
. Create the Image Configuration YAML by copying and pasting the following into the bastion host terminal.

[source,sh]
----
oc apply -f - <<EOF
apiVersion: config.openshift.io/v1
kind: Image
metadata:
  name: cluster
spec:
  registrySources:
    allowedRegistries:
      - quay.io
      - registry.redhat.io
      - registry.access.redhat.com
      - image-registry.openshift-image-registry.svc:5000
      - my-trusted-registry.internal.example.com
EOF
----

[TIP]
====
- `image-registry.openshift-image-registry.svc:5000` is needed for OpenShift’s own internal image registry.
- Add/remove registries as needed for your environment.
- Any registry used in your cluster must be in this list to pass the policy.
====

[start=6]
. Check that your changes have been accepted:

[source,sh]
----
oc get image.config.openshift.io/cluster -o yaml | grep allowedRegistries -A 10
----

**Output**
[source,sh]
----
    allowedRegistries:
    - quay.io
    - registry.redhat.io
    - registry.access.redhat.com
    - image-registry.openshift-image-registry.svc:5000
    - my-trusted-registry.internal.example.com
    - quay.io
status:
  internalRegistryHostname: image-registry.openshift-image-registry.svc:5000
----

[start=7]
**Verification**

. To verify remediation and compliance with the `ocp4-e8-ocp-allowed-registries` requirement:

.. Go back to the *RHACS* console.
.. Navigate to *Compliance* → *Scan Schedules* and locate your schedule (for example, `acs-catch-all`).
.. Use the menu on the schedule (three dots) and select "Run scan" to trigger a manual scan.

**Check Results**

[start=8]

.Click on the *Compliance* -> *OpenShift Coverage* -> *E8* tab.

- The `ocp4-e8-ocp-allowed-registries` check should now pass, showing your registry restrictions are correctly configured.
- If the check still fails, double-check your YAML for typos or missing registries in use by workloads.

[IMPORTANT]
====
Changes to Image configuration may take a few minutes to propagate in OpenShift. If the compliance check still fails after rescanning, wait a few minutes and run the scan again.
====

Well done! Updating allowed image registries is a great example of a quick compliance improvement you can implement in OpenShift. Other common hardening steps include enabling audit log forwarding or host node auditing with Linux auditd. These types of changes can be managed cluster-wide using the MachineConfig Operator, or automated at deployment time so new clusters are compliant out of the box—options include leveraging Ansible, ACM, or similar automation tools.

It’s important for Security and Operations teams to collaborate and ensure that clusters are provisioned with these baseline controls in place. Using the Compliance Operator and RHACS, you were able to test these configuration changes safely in our lab, validate that workloads continue to function as expected, and then propagate approved fixes into our broader operations and deployment workflows. This helps maintain continuous compliance across all environments.

== Observing your software and workload activity

== The Vulnerability Management dashboard

Let us continue by looking at our primary use case for RHACS that is the Vulnerability Management features and dashboard, a familiar topic for most security teams.

NOTE: For the following section, please note that the order in which the images appear or the number of components affected may vary depending on versions and other applications running in the cluster.

=== Vulnerability Management - Workload CVE

The Vulnerability Management tab in RHACS has seen significant improvements over the past year. It now focuses on categorizing vulnerabilities by workload, enabling scans for RHEL CoreOS, node-level issues, and correlating them with platform and application vulnerabilities. This helps security teams identify the software layer where the issue exists and the right team to address it.

More critical than fixing individual vulnerabilities is establishing a process to keep container images updated and prevent serious, fixable vulnerabilities from advancing through the pipeline. 

image::04-workload-1.png[link=self, window=blank, width=100%]

The *Workload CVE dashboard* shows hundreds of vulnerabilities, over 200 images, and 300+ deployments because multiple images are used across different deployments.

NOTE: The numbers may be different in your environments. 

Now it's time to find the same *patient-frontend* application and do some dissecting.

.Procedure

. Click the *Vulnerability Management -> Workload CVEs* tab
. Click the dropdown and select deployment.

image::04-workload-2.png[link=self, window=blank, width=100%]

[start=2]
. Click the second dropdown and select name.

image::04-workload-3.png[link=self, window=blank, width=100%]

[start=2]
. Then, filter for the *frontend* deployment.

image::04-workload-4.png[link=self, window=blank, width=100%]

You will notice that an extra filter was added to the default filters, showing only the single deployment that the "Developer" built in the Quay module.

[start=3]
. Click the *CVE* tab

image::04-workload-5.png[link=self, window=blank, width=100%]

From here you can analyze the vulnerabilites that the devoplers have introduced into the environment. 

====
CVE-2017-18342 & CVE-2020-14343 both are critical and are specific to the PyYAML package. This package is a high impact fix for the developers to focus on. 
====

image::04-workload-6.png[link=self, window=blank, width=100%]

IMPORTANT: Container OS age and the age of its components are a massive correlating factor to the number of vulnerabilites present. Speed is security when it comes to containers. 

[start=4]
. Click the *CVE-2020-14343* blue link.

image::04-workload-7.png[link=self, window=blank, width=100%]

If you're focused on a specific vulnerability, it's very helpful to see all the components it affects. With this dashboard you can see that our response to this vulnerability needs to be targeted, you should reach out directly to the development team that needs that PyYAML package.


IMPORTANT: As a security team our next step is to inform the development team about these vulnerabilities. Luckily, they should have already seen these issues in Quay. 

=== Vulnerability reporting

Internal vulnerability reporting improves software security by helping teams fix issues early, lowering the risk of breaches and failures. It promotes a security-focused mindset and ensures critical vulnerabilities are prioritized and resolved quickly, resulting in a more reliable product and increased user trust.

In the next part of the module, you will create a vulnerability report for a specific application deployment that would be sent to the development team.

.Procedure

[start=1]
. Click on the *Vulnerability Reporting* tab. 

image::vuln-report-01.png[link=self, window=blank, width=100%]

[start=2]
. Click the *Create report* button.

image::vuln-report-02.png[link=self, window=blank, width=100%]

You will see that creating a report is a three step process. It requires you to configure the report parameters and the delivery destination, and then you have to review and create your report.

The configurable parameters are the following:

- Report name
- Report description
- CVE severity
- CVE status
- Image type
- CVEs discovered since (with a date)
- And a Report scope.

[start=3]
. Fill out the information specific to your target deployment.

- Report name: `application-vulnerability-report`
- Report description (Optional): `Vulnerability report for application workloads`
- CVE severity: Critical + Important
- CVE status: Fixable + Unfixable
- Image type: Deployed + Watched
- CVEs discovered since: All time
- Include NVD CVSS

image::vuln-report-03.png[link=self, window=blank, width=100%]

====
You now have a vulnerability report configuration but you haven't targeted it to a specific deployment. That's what collections are for.
====

[start=4]
. Click on the "Select a collection" dropdown then select *Create collection*.

image::vuln-report-04.png[link=self, window=blank, width=100%]

You can create collection rules by deployment, namespace and cluster. The collections are setup this way so that you can easily attach policies, vulnerability reports and notifications by the logical groupings of your organization. 

[start=5]
. Give the collection a name (e.g., `application-workloads`)
. Click the dropdown and select *Deployments with names matching* then enter your deployment name pattern

image::vuln-report-05.png[link=self, window=blank, width=100%]

[start=6]
. Add a namespace rule. Select *Namespace with names matching* then enter your target namespace

====
If you do this correctly the deployment you are targeting should appear in the "collection results" information on the right of the screen.
====

image::vuln-report-06.png[link=self, window=blank, width=100%]

[start=7]
. Review the collection
. Scroll down and hit *Save*
. Click *Next* once you are back in the *Configure report parameters* tab

Next, create an example email notifier that will send an email on a schedule to remind the development team about the vulnerabilities in the deployment.

====
This notifier configuration demonstrates what is possible with RHACS. In a production environment, you would configure this with your actual SMTP server settings.
====

[start=8]
. Click *Add delivery destination -> Create email notifier* and enter the following

- Integration name: `application-security-notifier`
- Email server: `smtp.example.com:465`
- Click *Enable unauthenticated SMTP* (for lab purposes)
- From: `security team`
- Sender: `rhacs@example.com`
- Default recipient: `dev-team@example.com`

image::vuln-report-08.png[link=self, window=blank, width=100%]

NOTE: Don't worry if you don't want to enable the notification. The exercise is about going through the workflow. 

[start=9]
. Select a frequency. For example, weekly on Monday.
. Hit *Next*
. Review your configuration and click *Create*

image::vuln-report-09.png[link=self, window=blank, width=100%]

However, you don't have to wait until the scheduled time to view the report.

[start=10]
. Click the vertical ellipses on the right side of the UI and click *Generate Download*

image::vuln-report-10.png[link=self, window=blank, width=100%]

[start=11]
. Download the report and review the findings.

Excellent! You have successfully created a vulnerability report with automated delivery scheduling.

Now that the development team will receive regular reports about their vulnerabilities, it's time to create some guardrails for the application's behavior. 

== Policy Creation and Updates Based on Compliance Results (RHACS)

[[analyze-compliance]]

=== Update Policies Based on Results (namespace scoped)

[[update-policies]]


=== Roxctl installation

Roxctl is a command-line tool used to interact with Red Hat Advanced Cluster Security (RHACS) platform resources.

*Procedure*

. Download the latest roxctl binary for your operating system:

[source,sh,role=execute]
----
curl -LO "https://mirror.openshift.com/pub/rhacs/assets/4.9.0/bin/linux/roxctl"
----

. Make the binary executable:

[source,sh,role=execute]
----
chmod +x roxctl
----

. Move it to a location in your `$PATH` (such as `/usr/local/bin`):

[source,sh,role=execute]
----
sudo mv roxctl /usr/local/bin/
----

. Verify installation:

[source,sh,role=execute]
----
roxctl version
----
